---
title: "HW 4 - Turtles"
subtitle: "Part 4 - Drafting Viz"
description: "Due Tue 03/11/2025" 
author: "Eva Newby"
toc: true
warning: false
message: false 
eval: true
echo: true
format:
  html:
    embed-resources: true
editor_options: 
  chunk_output_type: console
---


```{r}
# Load libraries
library(tidyverse)
library(here)
library(dplyr)
library(ggplot2)
library(sf)
library(ggspatial)
library(prettymapr)
library(rnaturalearth)
library(rnaturalearthdata)
library(forcats)
library(ggimage)
library(viridis)
library(viridisLite)
library(showtext)
```

### Read in Turtle Nesting Data and Font Data

```{r}
# Set the SHAPE_RESTORE_SHX config option
Sys.setenv("SHAPE_RESTORE_SHX" = "YES")

# Read the shapefile
shapefile_path <- "C:/MEDS/EDS240-dataviz/Assignments/newby-eds240-HW4/data/nestingbeaches_GCB.shp"
turtles <- st_read(shapefile_path) %>% 
    janitor::clean_names()

# Font options from google
font_add_google("Lora", "lora") 
font_add_google("Quicksand", "quicksand") 
font_add_google("Gochi Hand", "gochi")
showtext_auto()
```

### Exploratory Data Analysis

```{r}
# Check CRS
st_crs(turtles)

# Unique Countries
unique(turtles$country)
```

### Clean and Wrangle Data

```{r}
# Get the bounding box for turtles
bbox <- st_bbox(turtles)
```

```{r}
# Assume data into regional names
turtles <- turtles %>% 
    mutate(region = case_when(rmu == 1 ~ "Caribbean and Gulf of Mexico",
                              rmu == 2 ~ "Southwest Atlantic",
                              rmu == 3 ~ "Southeast Atlantic",
                              rmu == 4 ~ "Mediterranean",
                              rmu == 5 ~ "Arabian",
                              rmu == 8 ~ "Eastern Indian",
                              TRUE ~ "Unknown")) %>% 
    filter(region %in% c('Caribbean and Gulf of Mexico', 'Southeast Atlantic', 'Mediterranean', 'Arabian', 'Eastern Indian', 'Southwest Atlantic'))

# Set bounding boxes for each region, will need to adjust for each region
bbox_carib <- st_bbox(c(xmin = -98, ymin = 10, xmax = -60, ymax = 35), crs = st_crs(turtles))
                     
bbox_seat <- st_bbox(c(xmin = -50, ymin = 0, xmax = 0, ymax = 40), crs = st_crs(turtles))

bbox_medit <- st_bbox(c(xmin = -10, ymin = 30, xmax = 40, ymax = 45), crs = st_crs(turtles))

# Save as list for easier access
bbox_list <- list(  "Caribbean and Gulf of Mexico" = bbox_carib,
                    "Southeast Atlantic"            = bbox_seat,
                    "Mediterranean"                 = bbox_medit)

# Add a new column so each entry has an assigned bbox
turtles <- turtles %>% 
    rowwise() %>% 
    mutate(bbox = list(bbox_list[[region]])) %>% 
    ungroup()
```


### Data Viz 1 - Bar Chart (move to 1)
go back to HW1, look at moving the label text into the bars


```{r}
# Summarize unique nest counts per region
region_counts <- turtles %>%
    st_drop_geometry() %>% 
    group_by(region) %>%
    summarize(nest_count = n()) %>%  # Count occurrences per region
    mutate(opacity_val = nest_count / max(nest_count))  # Normalize opacity (0-1)

# Join back to original data (so each region has its unique opacity)
turtles <- turtles %>%
    left_join(region_counts, by = "region")
```


```{r}
# Q2: World regions represented and their average nest count per year. ------------------------------------------------------------------------------- 
# per region

turtle_bar_plot <- turtles %>% 
    
    ggplot(aes(x = fct_rev(fct_infreq(region)),
               alpha = opacity_val))+
    
    geom_bar(fill = '#438D80')+
    
    geom_text(stat = 'count', 
              aes(label=after_stat(count)),
              hjust = 2,
              size = 8,
              color = "black",
              family = 'quicksand',
              fontface = "bold")+
    
    coord_flip()+
    
    geom_text(aes(x = region, y = 0, label = str_to_title(region)), 
             # family = 'gochi',
             family = "quicksand",
            #fontface = "bold",
            size = 8, 
            hjust = -0.03,
            nudge_y = 0.2) +
    
    labs(x = " ",
         y = "Number of Nests",
         title = " Average Loggerhead Turtle Nesting Counts ... (per year 1979 - 2023)")+
    
    theme_void()+
    
    theme(
        # text font
        text = element_text(family = "quicksand"),
        panel.grid.major.y = element_blank(),
        # axis.text.y = element_text(size = 10),
        plot.title = element_text(hjust = 0.5),

        # Sand colored background:
        panel.background = element_rect(fill = "#F4E7C5", color = NA),
        plot.background = element_rect(fill = "#F4E7C5", color = NA),
        legend.background = element_rect(fill = "#F4E7C5", color = NA),
        
        # Remove x and y axis labels
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(), 
    ) +
    guides(alpha = "none")
        

turtle_bar_plot   
```

### Data Viz 2 - World Map
Countries in the caribbean/gulf of mexico  and Southeast Atlantic - HIGHLIGHT 
opacity value for nesting sites. general patterns by country
3 separate maps (top3 locations from bar chart)
or just caribb

```{r}
# Q1: Where are sea turtles nesting? ---------------------------------------------------------------------------------

# View the nesting sites on a general basemap. interactive worldmap? geofacet package?
# Shadow the countries that have turtle nests. 
# Illuminate the beach locations in another color
overview_map <- ggplot()+
    annotation_map_tile()+
    geom_sf(data = turtles, color = '#438D80')+
    # add bounding box
    geom_rect(aes(xmin = bbox["xmin"], 
                  xmax = bbox["xmax"], 
                  ymin = bbox["ymin"], 
                  ymax = bbox["ymax"]),
              fill = NA) +
    coord_sf()+ # Change to Cartesian coordinates
    theme_void()+
    labs(title = "Turtle Nesting Locations (in green)")

overview_map
    
```

```{r}
# NEED HELP HERE
# Experimental caribbean map
# Get a world map as an sf object
world <- ne_countries(scale = "medium", returnclass = "sf")

# Check for any invalid geometries
st_is_valid(world)
st_is_valid(turtles)

# fix invalid geometries in turtles
library(lwgeom)
turtles <- st_make_valid(turtles)

# Convert bbox to an sf polygon
bbox_carib_sf <- st_as_sfc(bbox_carib)

# Ensure the polygon is valid
bbox_carib_sf <- st_make_valid(bbox_carib_sf)

bbox_carib_sf <- st_make_valid(bbox_carib)

# bbox is bbox_carib
caribbean_map <- st_crop(world, bbox_carib)

# Check CRS for both datasets
st_crs(world) == st_crs(turtles)


turtles_in_bbox <- st_crop(turtles, bbox_carib)


```

```{r}
# Experimental caribbean map, caribbean basemap data isn't showing up, need to dig into why, commented out for now.

# Create the ggplot map
carib_map <- ggplot() +
    geom_sf(data = caribbean_map, fill = "lightblue") +
    geom_sf(data = turtles, color = '#438D80', size = 2)+
    coord_sf(xlim = c(bbox_carib["xmin"], bbox_carib["xmax"]),
           ylim = c(bbox_carib["ymin"], bbox_carib["ymax"]),
           expand = FALSE) +
    labs(title = "Caribbean and Gulf of Mexico",
       subtitle = "Using rnaturalearth and ggplot2",
       x = "Longitude", y = "Latitude") +
    theme_minimal()

carib_map
```

### Data Viz 3 - Point and Line Chart
add in context/annotations
remove title

```{r}
# Add turtle icon
turtle_hatch <- "turtle-hatch.png"

# add turtle icon to each column that has a unique mann-kendall score value per country
turtles$image <- ifelse(duplicated(turtles$mann_kendal), NA, turtle_hatch)

# Filter for mann-kendall plot
mann_kendall_turtles = turtles %>% 
    filter(region %in% c('Caribbean and Gulf of Mexico', 'Southeast Atlantic'))

```

```{r}
# Just caribbean and gulf of mexico.
# Q3: Which regions that have nests have the highest variation in their mann-kendal slopes? ------------------------------------------------------

#  Mann-kendall plot per region

mann_kendall_plot <- mann_kendall_turtles %>%
    
  ggplot(aes(x = mann_kendal, 
             y = fct_rev(fct_infreq(region)))) +
    
  geom_line(aes(color = mann_kendal), 
            size = 4) +  
    
    # Use ggimage for turtle icons
  geom_image(aes(image = image), size = 0.06)+
    
    # Gradient color and gradient color legend
  scale_color_gradient2(low = "green", 
                        mid = "lightblue", 
                        high = "#438D80", 
                        midpoint = 0,
                        guide = guide_colorbar(title = NULL,
                                               barwidth = 23,
                                               barheight = 0.5),
                        breaks = c(-0.5, 0, 0.5),
                        labels = c("Decrease", "No Change", "Increase")) + 
    
    # "No change" h line
  geom_vline(xintercept = 0, 
             color = "black", 
             linetype = "dashed", 
             size = 0.8, 
             alpha = 0.5)+
  annotate("text", x = max(turtles$mann_kendal), 
           y = 0, 
           label = "No Change", 
           hjust = -1, 
           vjust = -30, # adjust this to move text
           angle = 90, 
           color = "black", 
           size = 3) +
    
    # label axes
  labs(x = "Change in Loggerhead Turtle Nesting Over Time (Mann-Kendall Slope)",
       y = "") +
  theme_minimal() +
  theme(legend.position = "bottom",
        # text font
        text = element_text(family = "quicksand"),
        
        # Sand colored background:
        panel.background = element_rect(fill = "#F4E7C5", color = NA),
        plot.background = element_rect(fill = "#F4E7C5", color = NA),
        legend.background = element_rect(fill = "#F4E7C5", color = NA),
        
       # plot.title = element_text(face = "bold", size = 14),
        axis.text = element_text(size = 12),
        legend.text = element_text(size = 10),
        
        # add dot/ turtle icon in the legend
        
        
        # increase plot margin on the right side
        plot.margin = margin(t = 10, r = 100, b = 10, l = 10)
    ) 

mann_kendall_plot
```
